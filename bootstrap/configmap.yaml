apiVersion: v1
kind: ConfigMap
metadata:
  name: k3sup-wrapper
data:
  k3sup-wrapper.sh: |
    #!/bin/bash
    set -ex
    K3S_VERSION="v1.30.4+k3s1"
    SERVER_IP="192.168.65.6"
    AGENT_IPS="192.168.65.7"
    USER=sentian
    CONFIG_FILE="config.yaml"
    if ! command -v k3sup &> /dev/null; then
      curl -sLS https://get.k3sup.dev | sh
      which k3sup
    fi
    mkdir -p /root/.ssh
    ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519_k3sup -N ""
    for IP in $SERVER_IP $AGENT_IPS; do
      ssh-copy-id -i /root/.ssh/id_ed25519_k3sup.pub "${USER}@${IP}"
    done
    k3sup install --ip $SERVER_IP --k3s-version $K3S_VERSION --k3s-extra-args="--config ${CONFIG_FILE}" --ssh-key $HOME/.ssh/id_ed25519 --user $USER
    for AGENT_IP in $AGENT_IPS; do
      k3sup join --ip $AGENT_IP --server-ip $SERVER_IP --k3s-version $K3S_VERSION --ssh-key $HOME/.ssh/id_ed25519 --user $USER
    done